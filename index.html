<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>POS Calculator</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- 引入 Babel 用于解析 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* 针对 iOS 的特殊优化 */
        body {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            user-select: none;
        }
        /* 隐藏滚动条但保留功能 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* 简单的淡入动画 */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* 模态框动画 */
        .modal-enter {
            animation: modalPop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes modalPop {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        /* チュートリアル用のスポットライト強調 */
        .spotlight-active {
            position: relative;
            z-index: 50;
            background-color: white;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.75);
            border-radius: 1rem;
        }
        /* オーバーレイ上の説明文 */
        .tutorial-tooltip {
            position: absolute;
            z-index: 60;
            pointer-events: auto;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 图标组件 (SVG) ---
        const IconDelete = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path><line x1="18" y1="9" x2="12" y2="15"></line><line x1="12" y1="9" x2="18" y2="15"></line></svg>
        );
        const IconRotateCcw = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"></path><path d="M3 3v9h9"></path></svg>
        );
        const IconFileText = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
        );
        const IconDownload = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
        );
        const IconX = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        );
        const IconSave = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
        );
        const IconSettings = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        );
        const IconHelp = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
        );
        const IconArrowRight = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
        );
        const IconCheck = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
        );

        // --- 颜色配置库 ---
        const COLOR_PALETTE = [
            { id: 'red', bg: 'bg-red-100', text: 'text-red-700', border: 'border-red-200' },
            { id: 'orange', bg: 'bg-orange-100', text: 'text-orange-700', border: 'border-orange-200' },
            { id: 'yellow', bg: 'bg-yellow-100', text: 'text-yellow-700', border: 'border-yellow-200' },
            { id: 'green', bg: 'bg-green-100', text: 'text-green-700', border: 'border-green-200' },
            { id: 'teal', bg: 'bg-teal-100', text: 'text-teal-700', border: 'border-teal-200' },
            { id: 'blue', bg: 'bg-blue-100', text: 'text-blue-700', border: 'border-blue-200' },
            { id: 'indigo', bg: 'bg-indigo-100', text: 'text-indigo-700', border: 'border-indigo-200' },
            { id: 'purple', bg: 'bg-purple-100', text: 'text-purple-700', border: 'border-purple-200' },
            { id: 'pink', bg: 'bg-pink-100', text: 'text-pink-700', border: 'border-pink-200' },
            { id: 'gray', bg: 'bg-gray-100', text: 'text-gray-700', border: 'border-gray-200' }
        ];

        // --- 多语言配置 ---
        const translations = {
            zh: {
                title: "智能收银计算器",
                viewRecord: "查看记录",
                record: "记录",
                total: "总计",
                received: "实收",
                change: "找零",
                inputReceived: "请输入实收...",
                receivable: "应收",
                download: "下载 CSV",
                noRecord: "暂无记录",
                currInput: "当前输入",
                setupTitle: "初始化设置",
                selectLang: "选择语言",
                prodCount: "自定义商品数量",
                setPrice: "设置价格与颜色",
                start: "开始使用",
                historyTitle: "交易记录",
                price: "价格",
                resetSetup: "重置设置",
                tapChangeColor: "点击颜色图标更改",
                selectColorTitle: "选择颜色",
                cancel: "取消",
                colors: {
                    red: "红色", orange: "橙色", yellow: "黄色", green: "绿色", teal: "青色",
                    blue: "蓝色", indigo: "靛色", purple: "紫色", pink: "粉色", gray: "灰色"
                },
                tutorial: {
                    ask: "需要查看使用教程吗？",
                    yes: "好的",
                    no: "不需要",
                    next: "下一步",
                    finish: "完成",
                    step1_desc: "在这里，您可以将预设商品快速添加到计算列表。稍后可在设置里调整数量，价格和颜色。",
                    step2_desc: "计算结果和输入过程会显示在这里。",
                    step3_desc: "使用数字键盘输入任意金额或数量。",
                    step4_desc: "商品选择完成后，点击绿色的“实收”按钮，输入顾客支付的金额，然后点击“=”计算找零。",
                    step5_desc: "最后，点击这里显示的黑色“记录”按钮，保存本次交易并开始下一笔。",
                    step6_desc: "在这里查看交易记录并下载CSV文件。",
                    step7_desc: "最后，您可以点击右上角的设置按钮，自定义商品数量、价格和颜色。",
                }
            },
            ja: {
                title: "スマートレジ電卓",
                viewRecord: "履歴を見る",
                record: "記録",
                total: "合計",
                received: "預かり",
                change: "お釣り",
                inputReceived: "預かり金を入力...",
                receivable: "小計",
                download: "CSV保存",
                noRecord: "履歴なし",
                currInput: "入力中",
                setupTitle: "初期設定",
                selectLang: "言語選択",
                prodCount: "商品ボタン数",
                setPrice: "価格と色設定",
                start: "開始",
                historyTitle: "取引履歴",
                price: "価格",
                resetSetup: "設定リセット",
                tapChangeColor: "色アイコンをタップして変更",
                selectColorTitle: "色を選択",
                cancel: "キャンセル",
                colors: {
                    red: "赤", orange: "オレンジ", yellow: "黄", green: "緑", teal: "ティール",
                    blue: "青", indigo: "藍", purple: "紫", pink: "ピンク", gray: "グレー"
                },
                tutorial: {
                    ask: "使い方のチュートリアルを見ますか？",
                    yes: "はい",
                    no: "いいえ",
                    next: "次へ",
                    finish: "完了",
                    step1_desc: "ここではプリセット商品をワンタップでリストに追加できます。後で設定画面から価格や色を変更可能です。",
                    step2_desc: "計算結果や入力プロセスがここに大きく表示されます。",
                    step3_desc: "テンキーを使って、登録されていない金額や数量を自由に入力できます。",
                    step4_desc: "商品を選んだら、緑色の「預かり」ボタンを押し、頂いた金額を入力して「=」でお釣りを計算します。",
                    step5_desc: "最後に、ここに表示される黒い「記録」ボタンを押すと、取引が保存され次の会計へ進みます。",
                    step6_desc: "左上のボタンから、これまでの取引履歴を確認したりCSVで保存したりできます。",
                    step7_desc: "右上の設定ボタンから、商品ボタンの数やそれぞれの価格・色を自由にカスタマイズできます。",
                }
            },
            en: {
                title: "Smart POS Calc",
                viewRecord: "History",
                record: "Record",
                total: "Total",
                received: "Cash",
                change: "Change",
                inputReceived: "Enter Cash...",
                receivable: "Total",
                download: "Download CSV",
                noRecord: "No records yet",
                currInput: "Input",
                setupTitle: "Setup",
                selectLang: "Language",
                prodCount: "Product Buttons",
                setPrice: "Set Prices & Colors",
                start: "Start",
                historyTitle: "History",
                price: "Price",
                resetSetup: "Reset",
                tapChangeColor: "Tap color icon to change",
                selectColorTitle: "Select Color",
                cancel: "Cancel",
                colors: {
                    red: "Red", orange: "Orange", yellow: "Yellow", green: "Green", teal: "Teal",
                    blue: "Blue", indigo: "Indigo", purple: "Purple", pink: "Pink", gray: "Gray"
                },
                tutorial: {
                    ask: "Do you want to see the tutorial?",
                    yes: "Yes",
                    no: "No",
                    next: "Next",
                    finish: "Finish",
                    step1_desc: "Tap these buttons to quickly add preset items. You can configure prices later.",
                    step2_desc: "Calculation results and input process appear here.",
                    step3_desc: "Use the keypad to enter custom amounts or quantities.",
                    step4_desc: "After selecting items, tap the green 'Cash' button, enter the amount received, and press '=' to calculate change.",
                    step5_desc: "Finally, tap the black 'Record' button here to save the transaction.",
                    step6_desc: "View transaction history and download CSV files here.",
                    step7_desc: "Tap the Settings button here to customize product count, prices, and colors.",
                }
            }
        };

        function App() {
          // --- 全局状态 ---
          const [appState, setAppState] = useState('lang_selection'); // 'lang_selection' | 'tutorial_ask' | 'calculator' | 'setup'
          const [lang, setLang] = useState('zh');
          
          // チュートリアル状態
          const [tutorialActive, setTutorialActive] = useState(false);
          const [tutorialStep, setTutorialStep] = useState(0);

          // 配置状态：每个商品包含 id, price, colorIdx
          const [customProdCount, setCustomProdCount] = useState(5);
          const [products, setProducts] = useState([
              { id: 0, price: 100, colorIdx: 0 }, 
              { id: 1, price: 200, colorIdx: 1 }, 
              { id: 2, price: 300, colorIdx: 3 }, // Green
              { id: 3, price: 400, colorIdx: 5 }, // Blue
              { id: 4, price: 500, colorIdx: 7 }  // Purple
          ]);
          
          // 颜色选择器状态 (用于设置界面)
          const [activeColorPickerIndex, setActiveColorPickerIndex] = useState(null);

          // --- 计算器核心状态 ---
          const [cartItems, setCartItems] = useState([]);
          const [currentItem, setCurrentItem] = useState({ value: '0', count: 1, isPreset: false });
          const [stage, setStage] = useState('input_value');
          const [displayValue, setDisplayValue] = useState('0');
          const [expression, setExpression] = useState(''); 
          
          // POS 状态
          const [mode, setMode] = useState('calculating'); 
          const [finalTotal, setFinalTotal] = useState(null);
          const [receivedAmount, setReceivedAmount] = useState(null);
          
          // 历史记录
          const [historyLog, setHistoryLog] = useState([]);
          const [showHistoryModal, setShowHistoryModal] = useState(false);
          const [counts, setCounts] = useState({}); // key: product id (0-4)

          const t = translations[lang];

          // 辅助函数
          const formatNumber = (num) => parseFloat(parseFloat(num).toPrecision(12)).toString();
          const getColor = (idx) => COLOR_PALETTE[idx % COLOR_PALETTE.length];
          const pad = (n) => n.toString().padStart(2, '0');

          // --- 初期化フロー ---
          const handleLangSelect = (selectedLang) => {
              setLang(selectedLang);
              setAppState('tutorial_ask');
          };

          const startTutorial = () => {
              setAppState('calculator');
              setTutorialActive(true);
              setTutorialStep(1); // 1:Products, 2:Screen, 3:Keypad, 4:Enter, 5:Record, 6:History, 7:Setup
          };

          const skipTutorial = () => {
              setAppState('calculator');
              setTutorialActive(false);
              setTutorialStep(0);
          };

          const nextTutorialStep = () => {
              if (tutorialStep < 7) {
                  setTutorialStep(tutorialStep + 1);
              } else {
                  setTutorialActive(false);
                  setTutorialStep(0);
              }
          };

          // --- 设置页面逻辑 ---
          const handleProductCountChange = (count) => {
              setCustomProdCount(count);
              // 调整 products 数组长度，保留已有设置
              setProducts(prev => {
                  const newProds = [];
                  for(let i=0; i<count; i++) {
                      // 如果之前有配置，沿用；否则生成新的，颜色轮询
                      newProds.push(prev[i] || { id: i, price: (i+1)*100, colorIdx: i % COLOR_PALETTE.length });
                  }
                  return newProds;
              });
          };

          const handlePriceChange = (index, newPrice) => {
              const newProds = [...products];
              newProds[index].price = parseFloat(newPrice) || 0;
              setProducts(newProds);
          };

          const handleColorSelect = (colorPaletteIndex) => {
              if (activeColorPickerIndex === null) return;
              setProducts(prev => {
                  const newProds = [...prev];
                  newProds[activeColorPickerIndex].colorIdx = colorPaletteIndex;
                  return newProds;
              });
              setActiveColorPickerIndex(null);
          };

          const exitSetup = () => {
              setAppState('calculator');
              // 初始化计数器
              const initCounts = {};
              products.forEach(p => initCounts[p.id] = 0);
              setCounts(initCounts);
              fullReset();
          };

          // --- 计算器核心逻辑 ---

          const inputDigit = (digit) => {
            if (mode === 'change') {
              fullReset();
              updateCurrentItemValue(String(digit));
              return;
            }

            if (stage === 'input_value') {
              let newVal;
              if (digit === '00') {
                newVal = currentItem.value === '0' ? '0' : currentItem.value + '00';
              } else {
                newVal = currentItem.value === '0' ? String(digit) : currentItem.value + digit;
              }
              updateCurrentItemValue(newVal);
            } else {
              // 数量输入
              const isJustSwitched = String(currentItem.value) === displayValue;
              let newDisplay;
              if (digit === '00') {
                newDisplay = (displayValue === '0' || isJustSwitched) ? '0' : displayValue + '00';
              } else {
                newDisplay = (displayValue === '0' || isJustSwitched) ? String(digit) : displayValue + digit;
              }
              setDisplayValue(newDisplay);
              setCurrentItem(prev => ({ ...prev, count: parseInt(newDisplay) || 0 }));
            }
          };

          const updateCurrentItemValue = (valStr) => {
            setCurrentItem(prev => ({ ...prev, value: valStr, isPreset: false })); 
            setDisplayValue(valStr);
          };

          const inputPreset = (product) => {
            if (navigator.vibrate) navigator.vibrate(50);
            if (mode === 'change') fullReset();

            if (stage === 'input_quantity' || (currentItem.value !== '0' && !currentItem.isPreset) || currentItem.isPreset) {
              commitCurrentItem();
            }

            setCurrentItem({ value: String(product.price), id: product.id, count: 1, isPreset: true });
            setDisplayValue(String(product.price));
            setStage('input_value');
          };

          const performOperation = (op) => {
            if (mode !== 'calculating') return;
            if (op === '×') {
              setStage('input_quantity');
            } else if (op === '+' || op === '-') {
              commitCurrentItem();
              setDisplayValue('0');
            }
          };

          const commitCurrentItem = () => {
            const val = parseFloat(currentItem.value);
            const count = currentItem.count;
            if (val === 0) return;

            const newItem = { ...currentItem, value: val }; 
            const newCart = [...cartItems, newItem];
            setCartItems(newCart);

            const itemStr = newItem.isPreset ? 
               (count > 1 ? `${val}×${count}` : `${val}`) : 
               (count > 1 ? `${val}×${count}` : `${val}`); 
            
            setExpression(prev => prev ? `${prev} + ${itemStr}` : itemStr);
            setCurrentItem({ value: '0', count: 1, isPreset: false });
            setStage('input_value');
          };

          const handleEqual = () => {
            let finalCart = [...cartItems];
            if (parseFloat(currentItem.value) !== 0) {
              finalCart.push({ ...currentItem, value: parseFloat(currentItem.value) });
            }
            if (finalCart.length === 0) return;

            const total = finalCart.reduce((acc, item) => acc + (item.value * item.count), 0);

            setCartItems([]); 
            setCurrentItem({ value: String(total), count: 1, isPreset: false });
            setStage('input_value');
            setDisplayValue(String(formatNumber(total)));
            
            const fullExp = finalCart.map(item => item.count > 1 ? `${item.value}×${item.count}` : item.value).join(' + ');
            setExpression(`${fullExp} =`);
            updateCountsFromCart(finalCart);
          };

          const updateCountsFromCart = (cart) => {
            setCounts(prevCounts => {
              const newCounts = { ...prevCounts };
              cart.forEach(item => {
                if (item.isPreset && item.id !== undefined) {
                   newCounts[item.id] = (newCounts[item.id] || 0) + item.count;
                }
              });
              return newCounts;
            });
          };

          const multiplyBy1Point1 = () => {
            let finalCart = [...cartItems];
            if (parseFloat(currentItem.value) !== 0) {
              finalCart.push({ ...currentItem, value: parseFloat(currentItem.value) });
            }

            let baseTotal = 0;
            if (finalCart.length > 0) {
              updateCountsFromCart(finalCart);
              baseTotal = finalCart.reduce((acc, item) => acc + (item.value * item.count), 0);
              const fullExp = finalCart.map(item => item.count > 1 ? `${item.value}×${item.count}` : item.value).join(' + ');
              setExpression(`(${fullExp}) × 1.1`);
              setCartItems([]);
            } else {
              baseTotal = parseFloat(displayValue);
              setExpression(prev => prev ? `(${prev}) × 1.1` : `× 1.1`);
            }

            if (baseTotal === 0) return;
            const newVal = baseTotal * 1.1;
            setDisplayValue(String(formatNumber(newVal)));
            setCurrentItem({ value: String(newVal), count: 1, isPreset: false });
          };

          const handlePayment = () => {
            let total = parseFloat(displayValue);
            const hasRawItems = cartItems.length > 0 || currentItem.isPreset;

            if (hasRawItems) {
               let finalCart = [...cartItems];
               if (parseFloat(currentItem.value) !== 0) {
                  finalCart.push({ ...currentItem, value: parseFloat(currentItem.value) });
               }
               updateCountsFromCart(finalCart);
               total = finalCart.reduce((acc, item) => acc + (item.value * item.count), 0);
            } 

            if (total === 0) return;
            setFinalTotal(total);
            setMode('paying');
            setDisplayValue('0');
            setCurrentItem({ value: '0', count: 1, isPreset: false });
            setExpression(`${t.receivable}: ${formatNumber(total)} | ${t.inputReceived}`);
          };

          const confirmPayment = () => {
            const received = parseFloat(displayValue);
            setReceivedAmount(received);
            const change = received - finalTotal;
            setDisplayValue(String(formatNumber(change)));
            setMode('change');
            setExpression(`${t.total}: ${formatNumber(finalTotal)} | ${t.received}: ${received}`);
          };

          const handleRecord = () => {
            const now = new Date();
            // 格式化日期 YYYY-MM-DD
            const dateStr = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}`;
            const timeStr = now.toTimeString().split(' ')[0];
            
            const newRecord = {
              id: Date.now(),
              date: dateStr, // 新增日期字段
              time: timeStr,
              counts: { ...counts },
              total: finalTotal,
              received: receivedAmount
            };
            setHistoryLog([newRecord, ...historyLog]);
            if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
            fullReset();
          };

          const fullReset = () => {
            setCartItems([]);
            setCurrentItem({ value: '0', count: 1, isPreset: false });
            setStage('input_value');
            setDisplayValue('0');
            setExpression('');
            setMode('calculating');
            setFinalTotal(null);
            setReceivedAmount(null);
            const resetCounts = {};
            products.forEach(p => resetCounts[p.id] = 0);
            setCounts(resetCounts);
          };
          
          const deleteLast = () => {
            if (mode === 'change') return;
            if (displayValue.length > 1) {
              const newVal = displayValue.slice(0, -1);
              setDisplayValue(newVal);
              if (stage === 'input_value') setCurrentItem(prev => ({...prev, value: newVal}));
              else setCurrentItem(prev => ({...prev, count: parseInt(newVal) || 0}));
            } else {
              setDisplayValue('0');
              if (stage === 'input_value') setCurrentItem(prev => ({...prev, value: '0'}));
              else setCurrentItem(prev => ({...prev, count: 0}));
            }
          };

          const downloadCSV = () => {
            let header = "date,time";
            products.forEach((p, idx) => {
                const colorName = t.colors[getColor(p.colorIdx).id];
                header += `,${colorName}(${p.price})`;
            });
            header += ",total,received\n";

            const rows = historyLog.map(item => {
              let row = `${item.date},${item.time}`;
              products.forEach(p => {
                  row += `,${item.counts[p.id] || 0}`;
              });
              row += `,${item.total},${item.received}`;
              return row;
            }).join("\n");
            
            const csvContent = "data:text/csv;charset=utf-8," + encodeURI(header + rows);
            const link = document.createElement("a");
            link.setAttribute("href", csvContent);
            link.setAttribute("download", `sales_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          };

          const Button = ({ label, onClick, className = "", colorClass = "bg-gray-100 text-gray-800 active:bg-gray-200" }) => (
            <button
              onClick={onClick}
              className={`
                h-14 sm:h-16 rounded-xl sm:rounded-2xl text-lg sm:text-xl font-semibold shadow-sm transition-all transform active:scale-95 flex items-center justify-center select-none relative
                ${colorClass} ${className}
              `}
            >
              {label}
            </button>
          );

          // --- UIパーツ: チュートリアル用の吹き出し ---
          // positionClass: Tailwindの配置クラス (例: "top-full left-1/2 -translate-x-1/2 mt-2")
          const TutorialBubble = ({ text, onNext, isLast, positionClass = "left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2" }) => (
              <div className={`tutorial-tooltip absolute w-64 bg-indigo-600 text-white p-4 rounded-xl shadow-2xl animate-bounce-subtle ${positionClass}`}>
                  <div className="text-sm mb-3 font-medium leading-relaxed">{text}</div>
                  <div className="flex justify-end">
                      <button onClick={onNext} className="bg-white text-indigo-600 px-4 py-1.5 rounded-lg text-sm font-bold shadow-sm active:bg-gray-100 z-50 pointer-events-auto">
                          {isLast ? t.tutorial.finish : t.tutorial.next}
                      </button>
                  </div>
              </div>
          );

          // --- 画面レンダリング ---

          // 1. 言語選択画面
          if (appState === 'lang_selection') {
              return (
                  <div className="flex items-center justify-center min-h-screen bg-gray-100 p-4">
                      <div className="bg-white rounded-3xl shadow-xl p-8 w-full max-w-sm text-center fade-in">
                          <h1 className="text-2xl font-bold text-gray-800 mb-6">Select Language</h1>
                          <div className="space-y-3">
                              <button onClick={() => handleLangSelect('zh')} className="w-full py-4 bg-gray-50 hover:bg-indigo-50 text-gray-800 font-bold rounded-xl border border-gray-200 transition-colors">中文</button>
                              <button onClick={() => handleLangSelect('ja')} className="w-full py-4 bg-gray-50 hover:bg-indigo-50 text-gray-800 font-bold rounded-xl border border-gray-200 transition-colors">日本語</button>
                              <button onClick={() => handleLangSelect('en')} className="w-full py-4 bg-gray-50 hover:bg-indigo-50 text-gray-800 font-bold rounded-xl border border-gray-200 transition-colors">English</button>
                          </div>
                      </div>
                  </div>
              );
          }

          // 2. チュートリアル確認画面
          if (appState === 'tutorial_ask') {
              return (
                  <div className="flex items-center justify-center min-h-screen bg-gray-100 p-4">
                      <div className="bg-white rounded-3xl shadow-xl p-8 w-full max-w-sm text-center fade-in">
                           <div className="mx-auto w-20 h-20 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mb-6">
                                <IconHelp size={40} />
                           </div>
                           <h2 className="text-xl font-bold text-gray-800 mb-8">{t.tutorial.ask}</h2>
                           <div className="flex gap-4">
                               <button onClick={skipTutorial} className="flex-1 py-3 bg-gray-200 text-gray-700 rounded-xl font-bold">{t.tutorial.no}</button>
                               <button onClick={startTutorial} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg">{t.tutorial.yes}</button>
                           </div>
                      </div>
                  </div>
              );
          }
          
          // 3. 設定画面
          if (appState === 'setup') {
              return (
                <div className="flex items-center justify-center min-h-screen p-4 relative">
                    <div className="w-full max-w-md bg-white rounded-3xl shadow-2xl p-6 fade-in flex flex-col gap-6">
                        <div className="flex justify-between items-center">
                            <h1 className="text-2xl font-bold text-gray-800 text-center flex-1">{t.setupTitle}</h1>
                            <button onClick={startTutorial} className="text-gray-400 hover:text-indigo-600 transition-colors p-1">
                                <IconHelp size={22} />
                            </button>
                        </div>
                        
                        {/* 语言选择 */}
                        <div>
                            <label className="block text-sm font-medium text-gray-500 mb-2">{t.selectLang}</label>
                            <div className="grid grid-cols-3 gap-2">
                                <button onClick={() => setLang('zh')} className={`py-2 rounded-lg ${lang==='zh' ? 'bg-indigo-600 text-white' : 'bg-gray-100'}`}>中文</button>
                                <button onClick={() => setLang('ja')} className={`py-2 rounded-lg ${lang==='ja' ? 'bg-indigo-600 text-white' : 'bg-gray-100'}`}>日本語</button>
                                <button onClick={() => setLang('en')} className={`py-2 rounded-lg ${lang==='en' ? 'bg-indigo-600 text-white' : 'bg-gray-100'}`}>English</button>
                            </div>
                        </div>

                        {/* 商品数量 */}
                        <div>
                            <label className="block text-sm font-medium text-gray-500 mb-2">{t.prodCount}: <span className="text-indigo-600 font-bold text-lg">{customProdCount}</span></label>
                            <input 
                                type="range" min="0" max="5" step="1" 
                                value={customProdCount} 
                                onChange={(e) => handleProductCountChange(parseInt(e.target.value))}
                                className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600"
                            />
                        </div>

                        {/* 价格与颜色设置 */}
                        {customProdCount > 0 && (
                            <div className="space-y-3">
                                <label className="block text-sm font-medium text-gray-500 flex justify-between">
                                    <span>{t.setPrice}</span>
                                    <span className="text-xs text-indigo-500 font-normal">{t.tapChangeColor}</span>
                                </label>
                                <div className="space-y-2 max-h-60 overflow-y-auto pr-1">
                                    {products.map((p, idx) => {
                                        const color = getColor(p.colorIdx);
                                        return (
                                            <div key={idx} className="flex items-center gap-3">
                                                <button 
                                                    onClick={() => setActiveColorPickerIndex(idx)}
                                                    className={`w-8 h-8 rounded-full shadow-sm ${color.bg} border-2 ${color.border} flex-shrink-0 transition-transform active:scale-90`}
                                                    aria-label="Change color"
                                                ></button>
                                                <span className="text-sm w-12 truncate text-gray-600">{t.colors[color.id]}</span>
                                                <input 
                                                    type="number" 
                                                    value={p.price} 
                                                    onChange={(e) => handlePriceChange(idx, e.target.value)}
                                                    className="flex-1 border rounded-lg px-3 py-2 text-right font-mono"
                                                    placeholder="Price"
                                                />
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        <button 
                            onClick={exitSetup}
                            className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold text-lg shadow-lg active:scale-95 transition-transform mt-2"
                        >
                            {t.start}
                        </button>
                    </div>

                    {/* 颜色选择模态框 */}
                    {activeColorPickerIndex !== null && (
                        <div className="fixed inset-0 bg-black/40 z-50 flex items-center justify-center p-4 fade-in backdrop-blur-sm" onClick={() => setActiveColorPickerIndex(null)}>
                            <div className="bg-white rounded-2xl p-6 w-full max-w-sm modal-enter shadow-2xl" onClick={e => e.stopPropagation()}>
                                <h3 className="text-lg font-bold mb-4 text-center text-gray-800">{t.selectColorTitle}</h3>
                                <div className="grid grid-cols-5 gap-3">
                                    {COLOR_PALETTE.map((c, idx) => (
                                        <button
                                            key={c.id}
                                            onClick={() => handleColorSelect(idx)}
                                            className="flex flex-col items-center gap-1 p-1 hover:bg-gray-50 rounded-lg"
                                        >
                                            <div className={`w-10 h-10 rounded-full ${c.bg} border-2 ${c.border} shadow-sm`}></div>
                                            <span className="text-[10px] text-gray-500">{t.colors[c.id]}</span>
                                        </button>
                                    ))}
                                </div>
                                <button 
                                    onClick={() => setActiveColorPickerIndex(null)}
                                    className="mt-6 w-full py-2 bg-gray-100 text-gray-600 rounded-xl font-medium active:bg-gray-200"
                                >
                                    {t.cancel}
                                </button>
                            </div>
                        </div>
                    )}
                </div>
              );
          }

          // 4. 計算機画面 (チュートリアル含む)
          return (
            <div className="flex items-center justify-center font-sans touch-manipulation min-h-screen relative">
              
              {/* チュートリアル用の背景オーバーレイ - クリックで次へ進む */}
              {tutorialActive && (
                  <div 
                    className="fixed inset-0 bg-black/20 z-40 transition-opacity duration-300 cursor-pointer"
                    onClick={nextTutorialStep}
                  ></div>
              )}

              <div className="w-full max-w-md bg-white h-screen sm:h-auto sm:min-h-[800px] sm:rounded-3xl sm:shadow-2xl overflow-hidden flex flex-col relative fade-in z-0">
                
                {/* 顶部状态栏 */}
                <div className={`bg-gray-900 text-gray-300 px-4 pt-12 pb-2 sm:pt-2 flex justify-between items-center text-xs sm:text-sm transition-all duration-300 ${tutorialStep === 6 || tutorialStep === 7 ? 'spotlight-active' : ''}`}>
                  <div className="flex gap-2 relative">
                     <button onClick={() => setShowHistoryModal(true)} className="flex items-center gap-1 hover:text-white transition-colors">
                        <IconFileText size={16} /> {t.viewRecord}
                     </button>
                     <button onClick={() => setAppState('setup')} className="flex items-center gap-1 hover:text-white transition-colors ml-2">
                        <IconSettings size={16} />
                     </button>
                     {/* 変更: ヘルプボタンクリックで確認画面へ */}
                     <button onClick={() => setAppState('tutorial_ask')} className="flex items-center gap-1 hover:text-white transition-colors ml-2">
                        <IconHelp size={16} />
                     </button>

                     {/* Step 6 Tutorial Bubble (履歴ボタンの下) */}
                     {tutorialStep === 6 && (
                         <TutorialBubble 
                            text={t.tutorial.step6_desc} 
                            onNext={nextTutorialStep} 
                            positionClass="top-full left-10 mt-2" 
                         />
                     )}

                     {/* Step 7 Tutorial Bubble (設定ボタンの下) */}
                     {tutorialStep === 7 && (
                         <TutorialBubble 
                            text={t.tutorial.step7_desc} 
                            onNext={nextTutorialStep} 
                            isLast
                            positionClass="top-full left-24 mt-2" 
                         />
                     )}
                  </div>
                  <div className="flex gap-2">
                    {/* 实时计数预览 */}
                    {(() => {
                      const previewCounts = { ...counts };
                      cartItems.forEach(item => { if(item.isPreset && item.id !== undefined) previewCounts[item.id] = (previewCounts[item.id]||0) + item.count; });
                      if(currentItem.isPreset && currentItem.id !== undefined) previewCounts[currentItem.id] = (previewCounts[currentItem.id]||0) + currentItem.count;
                      
                      return products.map((p, idx) => previewCounts[p.id] > 0 && (
                        <span key={p.id} className={`px-1.5 py-0.5 rounded text-[10px] ${getColor(p.colorIdx).bg} ${getColor(p.colorIdx).text}`}>
                          {previewCounts[p.id]}
                        </span>
                      ));
                    })()}
                  </div>
                </div>

                {/* 屏幕 */}
                <div className={`bg-gray-900 text-white p-6 pt-2 flex flex-col justify-end h-40 relative transition-all duration-300 ${tutorialStep === 2 ? 'spotlight-active' : ''}`}>
                  {/* Step 2 Tutorial Bubble (画面中央) */}
                  {tutorialStep === 2 && (
                      <TutorialBubble 
                        text={t.tutorial.step2_desc} 
                        onNext={nextTutorialStep} 
                        positionClass="left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2"
                      />
                  )}
                  <div className="text-gray-400 text-right text-sm min-h-[1.5rem] mb-1 break-words leading-tight">
                    {expression}
                    {currentItem.value !== '0' && stage === 'input_value' && cartItems.length > 0 && ` + ${currentItem.value}`}
                    {stage === 'input_quantity' && ` × ${currentItem.count}`}
                  </div>
                  <div className="flex justify-between items-end">
                    <div className="text-xs text-indigo-400 font-bold mb-2">
                       {mode === 'paying' ? t.received : mode === 'change' ? t.change : t.currInput}
                    </div>
                    <div className="text-right text-5xl font-light tracking-wide break-all">
                      {displayValue}
                    </div>
                  </div>
                </div>

                {/* 键盘区域 - 动态布局 */}
                <div className="flex-1 p-3 bg-gray-50 pb-8 sm:pb-4 flex flex-col gap-2 relative">
                  
                  {/* 自定义商品区域 + 功能键 (自动网格) */}
                  <div className={`grid grid-cols-4 gap-2 transition-all duration-300 p-1 relative ${tutorialStep === 1 ? 'spotlight-active' : ''}`}>
                      {/* Step 1 Bubble (商品ボタンの下) */}
                      {tutorialStep === 1 && (
                          <TutorialBubble 
                            text={t.tutorial.step1_desc} 
                            onNext={nextTutorialStep} 
                            positionClass="top-full left-1/2 -translate-x-1/2 mt-4 z-50"
                          />
                      )}
                      
                      {/* 商品按钮 */}
                      {products.map((p, idx) => {
                          const color = getColor(p.colorIdx);
                          return (
                              <Button 
                                key={p.id} 
                                label={p.price} 
                                onClick={() => inputPreset(p)} 
                                colorClass={`${color.bg} ${color.text} active:bg-gray-50 border ${color.border}`} 
                              />
                          );
                      })}
                      
                      {/* 功能按钮 */}
                      <Button label="x1.1" onClick={multiplyBy1Point1} colorClass="bg-teal-600 text-white active:bg-teal-700 font-bold" />
                      <Button label={<IconRotateCcw size={20}/>} onClick={fullReset} colorClass="bg-gray-200 text-red-600 active:bg-gray-300" />
                      <Button label={<IconDelete size={20}/>} onClick={deleteLast} colorClass="bg-gray-200 text-gray-700 active:bg-gray-300" />
                  </div>

                  <hr className="border-gray-200 my-1"/>

                  {/* 数字键盘固定布局 */}
                  <div className={`grid grid-cols-4 gap-2 flex-1 transition-all duration-300 p-1 relative ${tutorialStep === 3 || tutorialStep === 4 || tutorialStep === 5 ? 'spotlight-active' : ''}`}>
                      
                      {/* Step 3 Bubble (テンキーの上) */}
                      {tutorialStep === 3 && (
                          <TutorialBubble 
                            text={t.tutorial.step3_desc} 
                            onNext={nextTutorialStep} 
                            positionClass="bottom-full left-1/2 -translate-x-1/2 mb-4 z-50"
                          />
                      )}
                      
                      {/* Step 4 Bubble (預かりボタンの隣＝左側) */}
                      {tutorialStep === 4 && (
                          <TutorialBubble 
                            text={t.tutorial.step4_desc} 
                            onNext={nextTutorialStep} 
                            positionClass="top-4 right-1/4 mr-2 z-50"
                          />
                      )}
                      
                      {/* Step 5 Bubble (記録ボタンの上) */}
                      {tutorialStep === 5 && (
                          <TutorialBubble 
                            text={t.tutorial.step5_desc} 
                            onNext={nextTutorialStep} 
                            positionClass="bottom-20 right-24 z-50"
                          />
                      )}

                      <Button label="7" onClick={() => inputDigit(7)} colorClass="bg-white text-gray-900 shadow-sm border border-gray-100" />
                      <Button label="8" onClick={() => inputDigit(8)} colorClass="bg-white text-gray-900 shadow-sm border border-gray-100" />
                      <Button label="9" onClick={() => inputDigit(9)} colorClass="bg-white text-gray-900 shadow-sm border border-gray-100" />
                      <Button label={t.received} onClick={handlePayment} colorClass="bg-emerald-600 text-white font-bold text-lg active:bg-emerald-700 shadow-sm" />

                      <Button label="4" onClick={() => inputDigit(4)} colorClass="bg-white text-gray-900 shadow-sm border border-gray-100" />
                      <Button label="5" onClick={() => inputDigit(5)} colorClass="bg-white text-gray-900 shadow-sm border border-gray-100" />
                      <Button label="6" onClick={() => inputDigit(6)} colorClass="bg-white text-gray-900 shadow-sm border border-gray-100" />
                      <Button label="×" onClick={() => performOperation('×')} colorClass="bg-indigo-50 text-indigo-600 font-bold text-xl" />

                      <Button label="1" onClick={() => inputDigit(1)} colorClass="bg-white text-gray-900 shadow-sm border border-gray-100" />
                      <Button label="2" onClick={() => inputDigit(2)} colorClass="bg-white text-gray-900 shadow-sm border border-gray-100" />
                      <Button label="3" onClick={() => inputDigit(3)} colorClass="bg-white text-gray-900 shadow-sm border border-gray-100" />
                      <Button label="+" onClick={() => performOperation('+')} colorClass="bg-indigo-50 text-indigo-600 font-bold text-xl" />

                      <Button label="0" onClick={() => inputDigit(0)} colorClass="bg-white text-gray-900 shadow-sm border border-gray-100" />
                      <Button label="00" onClick={() => inputDigit('00')} colorClass="bg-white text-gray-900 shadow-sm border border-gray-100 font-bold" />
                      
                      {mode === 'change' || (tutorialActive && tutorialStep === 5) ? (
                         <Button label={<div className="flex items-center gap-1"><IconSave size={18}/> {t.record}</div>} onClick={handleRecord} colorClass={`bg-gray-800 text-white text-sm sm:text-lg active:bg-black shadow-lg ${tutorialStep === 5 ? 'ring-4 ring-yellow-400 ring-offset-2' : ''}`} />
                      ) : mode === 'paying' ? (
                         <Button label="=" onClick={confirmPayment} colorClass="bg-blue-600 text-white text-2xl active:bg-blue-700 shadow-lg" />
                      ) : (
                         <Button label="=" onClick={handleEqual} colorClass={`bg-blue-600 text-white text-2xl active:bg-blue-700 shadow-lg ${tutorialStep === 4 ? 'ring-4 ring-yellow-400 ring-offset-2' : ''}`} />
                      )}

                      <Button label="+" onClick={() => performOperation('+')} colorClass="bg-indigo-50 text-indigo-600 font-bold text-xl" />
                  </div>
                </div>

                {/* 历史记录模态框 */}
                {showHistoryModal && (
                  <div className="absolute inset-0 bg-gray-900/50 backdrop-blur-sm z-50 flex justify-end">
                    <div className="w-4/5 sm:w-2/3 bg-white h-full shadow-2xl flex flex-col animate-in slide-in-from-right duration-200">
                      <div className="p-4 border-b flex justify-between items-center bg-gray-50">
                        <h2 className="font-bold text-lg text-gray-800">{t.historyTitle}</h2>
                        <button onClick={() => setShowHistoryModal(false)} className="p-2 bg-gray-200 rounded-full hover:bg-gray-300">
                          <IconX size={20} />
                        </button>
                      </div>
                      <div className="flex-1 overflow-y-auto p-4 space-y-3">
                        {historyLog.length === 0 ? <div className="text-center text-gray-400 mt-10">{t.noRecord}</div> : historyLog.map((log) => (
                          <div key={log.id} className="bg-white border rounded-xl p-3 shadow-sm text-sm">
                            {/* 显示日期和时间 */}
                            <div className="flex justify-between mb-2">
                              <div className="flex flex-col">
                                  <span className="text-[10px] text-gray-400 font-normal">{log.date}</span>
                                  <span className="font-bold text-gray-700">{log.time}</span>
                              </div>
                              <span className="font-mono font-bold text-indigo-600 self-center">¥{formatNumber(log.total)}</span>
                            </div>
                            <div className="flex flex-wrap gap-1 mb-2">
                              {products.map((p, idx) => {
                                const count = log.counts[p.id] || 0;
                                if (count <= 0) return null;
                                const color = getColor(p.colorIdx);
                                return (
                                  <span key={p.id} className={`text-[10px] px-1.5 rounded ${color.bg} ${color.text}`}>{p.price}×{count}</span>
                                );
                              })}
                            </div>
                          </div>
                        ))}
                      </div>
                      <div className="p-4 border-t bg-gray-50">
                        <button onClick={downloadCSV} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-semibold flex items-center justify-center gap-2 active:bg-indigo-700">
                          <IconDownload size={20} /> {t.download}
                        </button>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>